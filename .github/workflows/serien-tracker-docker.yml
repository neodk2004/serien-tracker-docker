name: Test Serien Tracker

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and start app
        run: |
          echo "OMDb_API_KEY=${{ secrets.OMDb_API_KEY }}" > .env
          docker compose up --build -d

      - name: Wait for startup
        run: sleep 20

      - name: Test /login endpoint
        run: |
          if curl -f --max-time 10 http://localhost:8080/login; then
            echo "✅ App is reachable"
          else
            echo "❌ App not reachable – showing logs:"
            docker compose logs
            exit 1
          fi
